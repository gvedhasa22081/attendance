<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Smart Face Attendance System</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <script defer src="https://unpkg.com/face-api.js"></script>

  <style>
    body {
      background: #0b1221;
      color: white;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }

    h1 {
      color: #3ba4ff;
      margin-bottom: 20px;
    }

    #video {
      width: 500px;
      height: 350px;
      border: 4px solid #3ba4ff;
      border-radius: 10px;
      background: rgba(255,255,255,0.05);
    }

    #startBtn {
      margin-top: 20px;
      padding: 12px 25px;
      border-radius: 8px;
      background: #3b82f6;
      color: white;
      font-size: 18px;
      cursor: pointer;
      border: none;
    }

    #dashboard {
      margin-top: 30px;
      background: rgba(255,255,255,0.08);
      padding: 20px;
      border-radius: 15px;
      width: 500px;
      margin-left: auto;
      margin-right: auto;
      text-align: left;
    }

    .section-title {
      font-size: 22px;
      margin-bottom: 10px;
      font-weight: bold;
    }

    .name {
      font-size: 18px;
      margin: 5px 0;
    }
  </style>

</head>

<body>

  <h1>SMART FACE ATTENDANCE SYSTEM</h1>

  <video id="video" autoplay muted></video>

  <br />
  <button id="startBtn">Start Attendance</button>

  <div id="dashboard">
    <div class="section-title">Present Students</div>
    <div id="presentList"></div>

    <div class="section-title" style="margin-top:20px;">Pending Students</div>
    <div id="pendingList"></div>
  </div>

<script>
  const video = document.getElementById("video");

  // ---------------------------------------------------------
  // LOAD MODELS (GitHub Pages FIX) — using ./models/
  // ---------------------------------------------------------
  Promise.all([
    faceapi.nets.tinyFaceDetector.loadFromUri("./models"),
    faceapi.nets.faceRecognitionNet.loadFromUri("./models"),
    faceapi.nets.faceLandmark68Net.loadFromUri("./models")
  ]).then(() => console.log("Models Loaded ✔"));

  // ---------------------------------------------------------
  // START CAMERA
  // ---------------------------------------------------------
  document.getElementById("startBtn").onclick = async () => {
    navigator.mediaDevices.getUserMedia({ video: {} })
      .then(stream => {
        video.srcObject = stream;
      });
  };

  // ---------------------------------------------------------
  // LOAD STUDENT IMAGES
  // ---------------------------------------------------------
  async function loadStudentData() {
    const names = [
      "Ajith_Kumar",
      "Hari_Chandana",
      "Keerthana",
      "Shiva_Narayana",
      "Vedha_Sai_G"
    ];

    let labeledDescriptors = [];

    for (let name of names) {
      const imgUrl = `./students/${name}.jpeg`;
      const img = await faceapi.fetchImage(imgUrl);

      const detection = await faceapi
        .detectSingleFace(img)
        .withFaceLandmarks()
        .withFaceDescriptor();

      if (!detection) {
        console.log("❌ Face not detected for:", name);
        continue;
      }

      labeledDescriptors.push(
        new faceapi.LabeledFaceDescriptors(name, [detection.descriptor])
      );
    }

    return labeledDescriptors;
  }

  // ---------------------------------------------------------
  // FACE MATCHING + ATTENDANCE
  // ---------------------------------------------------------
  video.addEventListener("play", async () => {
    const labeledDescriptors = await loadStudentData();
    const faceMatcher = new faceapi.FaceMatcher(labeledDescriptors, 0.45);

    const presentSet = new Set();
    const allStudents = [
      "Ajith_Kumar",
      "Hari_Chandana",
      "Keerthana",
      "Shiva_Narayana",
      "Vedha_Sai_G"
    ];

    setInterval(async () => {
      const detections = await faceapi
        .detectAllFaces(video, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptors();

      detections.forEach(det => {
        const match = faceMatcher.findBestMatch(det.descriptor);

        if (match.label !== "unknown") {
          presentSet.add(match.label);
        }
      });

      updateDashboard(presentSet, allStudents);
    }, 1000);
  });

  // ---------------------------------------------------------
  // UPDATE UI
  // ---------------------------------------------------------
  function updateDashboard(presentSet, all) {
    const presentList = document.getElementById("presentList");
    const pendingList = document.getElementById("pendingList");

    presentList.innerHTML = "";
    pendingList.innerHTML = "";

    all.forEach(name => {
      if (presentSet.has(name)) {
        presentList.innerHTML += `<div class="name">✔ ${name}</div>`;
      } else {
        pendingList.innerHTML += `<div class="name">⏳ ${name}</div>`;
      }
    });
  }
</script>

</body>
</html>
